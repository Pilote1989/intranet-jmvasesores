<block start="bloqueEditarLiquidacion"/>

<div class="widget-box">
  <div class="widget-header">
    <h4>{editar}</h4>
  </div>
  <div class="widget-body">
    <div class="widget-main no-padding">
      <form class="form-horizontal" enctype="multipart/form-data" method="POST" name="principal2" id="principal2" action="?do=liquidaciones.procesarCedida" role="form">
        <!-- <legend>Form</legend> -->
        
        <fieldset>
          <div id="paso1">
            <div class="form-group">
              <label for="vendedor" class="col-sm-3 control-label no-padding-right"> Vendedor </label>
              <div class="col-sm-9">
                  <input name="vendedor" id="vendedor" type="hidden" value="{persona}">
                  <input name="persona_persona_name" id="persona_name" type="text" class="form-control" readonly value="{personaNombre}">
              </div>
            </div>
            <div class="form-group">
              <label for="moneda" class="col-sm-3 control-label no-padding-right">Moneda</label>
              <div class="col-sm-9">
                  <input name="moneda" id="moneda" type="text" class="form-control" readonly value="{moneda}">
              </div>
            </div>
            <div class="form-group" style="display:none">
              <label for="buscarAsegurado" class="col-sm-3 control-label no-padding-right"> Asegurado </label>
              <div class="input-group col-sm-9">
                <div class="input-group">
                  <input name="buscarAsegurado" id="buscarAsegurado" type="text" class="form-control">
                  <span class="input-group-addon" id="busAsegurado"> <i class="ace-icon fa fa-search bigger-110"></i> </span>
                </div>
              </div>
            </div>
            <div class="col-xs-12" id="buscando">
              <div id="progressbar" class="ui-progressbar ui-widget ui-widget-content ui-corner-all progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="37">
                <div class="ui-progressbar-value ui-widget-header ui-corner-left progress-bar progress-bar-success" style="width: 100%;">
                </div>
              </div>
            </div>
            <div class="col-xs-12" id="tablaComisiones">
              <div class="table-header">
                Comisiones Pendientes para el Cliente
              </div>
              <div class="table-responsive">
                <table id="resultados" class="table table-striped table-bordered table-hover">
                  <thead>
                    <tr>
                      <th>&nbsp;</th>
                      <th>Tipo</th>
                      <th>Cliente</th>
                      <th>Aviso</th>
                      <th>Poliza</th>
                      <th>Prima Neta</th>
                      <th>Comision</th>
                      <th>Comision Cedida</th>
                    </tr>
                  </thead>
                  <tbody>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="alert alert-danger col-xs-12" id="alertaNinguna" style="margin-top:20px">
              <button type="button" class="close" data-dismiss="alert">
                <i class="ace-icon fa fa-remove"></i>
              </button>
              <strong> <i class="ace-icon fa fa-remove"></i> Â¡Error! </strong> No hay ninguna comision seleccionada. <br>
            </div>
            <div class="col-xs-12" id="tablaComisionesSeleccionadas">
              <div class="table-header">
                Comisiones Seleccionadas
              </div>
              <div class="table-responsive">
                <table id="resultadosSeleccionados" class="table table-striped table-bordered table-hover">
                  <thead>
                    <tr>
                      <th>&nbsp;</th>
                      <th>Tipo</th>
                      <th>Cliente</th>
                      <th>Aviso</th>
                      <th>Poliza</th>
                      <th>Prima Neta</th>
                      <th>Comision</th>
                      <th>Comision Cedida</th>
                    </tr>
                  </thead>
                  <tbody>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div id="paso2">
            <div class="row">
              <div class="col-sm-10 col-sm-offset-1">
                <div class="widget-box transparent invoice-box">
                  <div class="widget-header widget-header-large">
                    <h3 class="grey lighter pull-left position-relative"> <i class="ace-icon fa fa-leaf green"></i> Liquidacion de Comisiones </h3>
                  </div>
                  <div class="widget-body">
                    <div class="widget-main padding-24">
                      <div class="row">
                        <div class="col-sm-12">
                          <div class="row">
                            <div class="form-group">
                              <label for="factura" class="col-sm-3 control-label no-padding-right">Factura</label>
                              <div class="col-sm-9">
                                <div class="clearfix">
                                  <input name="factura" type="text"  class="col-sm-12 col-xs-12"  id="factura"   placeholder="Factura" value="{factura}">
                                </div>
                              </div>
                            </div>
                            <div class="form-group">
                              <label for="fecha" class="col-sm-3 control-label no-padding-right">Fecha</label>
                              <div class="col-sm-9">
                                <div class="clearfix">
                                  <input name="fecha" type="text" class="col-sm-12 col-xs-12 date-picker"  id="fecha" value="{fechaFactura}" data-date-format="dd/mm/yyyy" >
                                </div>
                              </div>
                            </div>
                            <div class="form-group">
                              <label for="obser" class="col-sm-3 control-label no-padding-right">Observaciones</label>
                              <div class="col-sm-9">
                                <div class="clearfix">
                                  <input name="obser" type="text" class="col-sm-12 col-xs-12 "  id="obser" value="{observaciones}">
                                </div>
                              </div>
                            </div>
                          </div>
                          <div class="row">
                            <div class="col-xs-12 label label-lg label-info arrowed-in arrowed-right">
                              <b>Vendedor : {personaNombre}<span id="spanCia"></span></b>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div>
                        <table class="table table-striped table-bordered">
                          <thead>
                            <tr>
                              <th class="center">#</th>
                              <th>Tipo</th>
                              <th>Cliente</th>
                              <th>Aviso</th>
                              <th>Poliza</th>
                              <th>Prima Neta</th>
                              <th>Comision</th>
                              <th>Comision Cedida(%)</th>
                              <th>Comision Cedida</th>
                            </tr>
                          </thead>
                          <tbody id="comisionesFinal">
                          </tbody>
                        </table>
                      </div>
                      <div class="hr hr8 hr-double hr-dotted">
                      </div>
                      <div class="row">
                        <div class="col-sm-5 pull-right">
                          <h5 class="pull-right"> Sub Total :
                            <input name="subTotal" type="text" class="input-sm" id="subTotal"/>
                          </h5>
                        </div>
                        <div class="col-sm-7 pull-left">
                        &nbsp;
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-sm-5 pull-right">
                          <h5 class="pull-right"> IGV :
                            <input name="igv" type="text" class="input-sm" id="igv"/>
                          </h5>
                        </div>
                        <div class="col-sm-7 pull-left">
                        &nbsp;
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-sm-5 pull-right">
                          <h4 class="pull-right"> Total Factura :
                            <input name="totalFac" type="text" class="input-sm" id="totalFac"/>
                            
							<input name="idCedida" id="idCedida" type="hidden" value="{idCedida}">
                          </h4>
                        </div>
                        <div class="col-sm-7 pull-left">
                        &nbsp;
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </fieldset>
        <div class="form-actions center">
          <button class="btn btn-sm btn-info" type="button" id="siguiente">
            Siguiente <i class="ace-icon fa fa-arrow-right fa-on-right bigger-110"></i>
          </button>
          <button class="btn btn-sm btn-info" type="button" id="anterior">
            <i class="ace-icon fa fa-arrow-left fa-on-right bigger-110"></i> Anterior
          </button>
          <button class="btn btn-sm btn-success" type="button" id="terminar">
            <i class="ace-icon fa fa-arrow-right fa-on-right bigger-110"></i> Guardar
          </button>
          <button class="btn btn-sm btn-light disabled " type="button" id="loading" style="display: inline-block;"> <img src="assets/img/loading.gif"/> Validando... </button>
        </div>
      </form>
    </div>
  </div>
</div>
<block end="bloqueEditarLiquidacion"/>

<script>
	$('#principal2').validate({
		errorElement: 'div',
		errorClass: 'help-block',
		focusInvalid: false,
		rules: {
			factura: {
				required: true,
			},
			fecha: {
				required: true,
				remote: {
					url: "?do=contabilidad.revisarMes",
					type: "post",
          beforeSend: function(e){
            $('#loading').show();
            $('#terminar').hide();
          },
          complete: function(e, valid){
            $('#loading').hide();
            $('#terminar').show();
          },
					data: {
						mes: function() {
						  var d =  $( "#fecha" ).val().split("/");
							return d["1"];
						},
						anio: function() {
						  var d =  $( "#fecha" ).val().split("/");
							return d["2"];
						}
					}
				}
			},
		},

		messages: {
			factura: {
				required: "Ingrese el Numero de Factura",
			},
			fecha: {
				required: "Ingrese la fecha de la factura",
				remote: "El mes se encuentra cerrado",
			},
		},

		invalidHandler: function (event, validator) { //display error alert on form submit   
			$('.alert-danger', $('.login-form')).show();
			$('select').attr('disabled','disabled');
		},

		highlight: function (e) {
			$(e).closest('.form-group').removeClass('has-info').addClass('has-error');
		},

		success: function (e) {
			$(e).closest('.form-group').removeClass('has-error').addClass('has-info');
			$(e).remove();
			
		},

		errorPlacement: function (error, element) {
			if(element.is(':checkbox') || element.is(':radio')) {
				var controls = element.closest('div[class*="col-"]');
				if(controls.find(':checkbox,:radio').length > 1) controls.append(error);
				else error.insertAfter(element.nextAll('.lbl:eq(0)').eq(0));
			}
			else if(element.is('.select2')) {
				error.insertAfter(element.siblings('[class*="select2-container"]:eq(0)'));
			}
			else if(element.is('.chosen-select')) {
				error.insertAfter(element.siblings('[class*="chosen-container"]:eq(0)'));
			}
			else error.insertAfter(element.parent());
		},
	});

var seleccionados = [{ids}];
var seleccionadosTipos = [{tipos}];

$('#loading').hide();
$("#paso2").hide();
$("#anterior").hide();
$("#terminar").hide();
$("#alertaNinguna").hide();
$("#anterior").click(function() {
	$("#paso1").show();
	$("#paso2").hide();
	$("#anterior").hide();
	$("#terminar").hide();
	$("#siguiente").show();
});
$("#siguiente").click(function() {
	if(seleccionados.length > 0){
		$("#paso1").hide();
		$("#paso2").show();
		$("#anterior").show();
		$("#terminar").show();
		$("#siguiente").hide();
		$("#comisionesFinal").empty();
		var suma=0;
		var i=0;
		$.ajax({
			url: "?do=cobros.obtenerCobros&ids=" + seleccionados.toString() + "&tipos=" + seleccionadosTipos.toString(),
			dataType: 'json',
			success: function(data){
				$.each(data, function() {			  
					i++;
					$('#comisionesFinal').append('<tr>'+		
					'<td><input name="idCobro[]" class="input-small" type="hidden" value="' + this.cobroId + '"/>' + i + '</td>' + 
					'<td>' + this.tipo + '</td>' + 
					'<td>' + this.nom + '</td>' + 
					'<td>' + this.avi + '</td>' + 
					'<td>' + this.num + '</td>' + 
					'<td>' + this.neta + '</td>' + 
					'<td>' + this.com + '</td>' + 
					'<td><input name="facComisionP[]" class="input-small" type="text" value="' + this.comCP + '"/></td>' + 
					'<td><input name="facComision[]" class="input-small comisionEdita" type="text" value="' + this.comC + '"/></td>' + 
					'</tr>');
					suma += parseFloat(this.com);
					$('#subTotal').val(suma.toFixed(2));
					$('#igv').val((suma * 0.18).toFixed(2));
					$('#totalFac').val((suma * 1.18).toFixed(2));
				});
			},
			error: function(e){
				console.log(e.responseText);
			}
		});
	}else{
		$("#alertaNinguna").show();
	}
});


$('#fecha').mask("99/99/9999");
$('#fecha').datepicker({
  autoclose:true,
});

$(document).on('change', '#fecha', function() {
  //$(this).closest('.form-group').removeClass('has-error');
  //$(this).closest('.help-block').hide();
  $("#principal2").validate().element("#fecha");
});

$("#terminar").click(function() {
	$('select').removeAttr('disabled');
	$("#principal2").submit();
});

$("#tablaComisiones").hide();
$("#buscando").hide();
	var dTable = $('#resultados').dataTable( {
		"aoColumns": [
		  { "bSortable": false },
		  null, null,null, null, null, null, null
		],
		"iDisplayLength" : 5,
		"aLengthMenu": [[5, 10, 25, -1], [5 , 10, 25, "Todos"]]
	});
$("form").keypress(function(e) {
  if (e.which == 13) {
    return false;
  }
});
var dTableSeleccionados = $('#resultadosSeleccionados').dataTable( {
	"aoColumns": [
	  { "bSortable": false },
	  null, null,null, null, null, null, null,
	],
	"oLanguage": {
		"sUrl": "assets/js/dataTableSpanish.json"
	},
	"iDisplayLength" : 5,
	"aLengthMenu": [[5, 10, 25, -1], [5 , 10, 25, "Todos"]]
});


$('#comisionesFinal').on( 'change', 'input', function (e) {
	var temp19 = parseFloat(0);
	$( ".comisionEdita" ).each(function( index ) {
		temp19 += parseFloat($( this ).val());
	});
	$('#subTotal').val(temp19.toFixed(2));
	$('#igv').val((temp19 * 0.18).toFixed(2));
	$('#totalFac').val((temp19 * 1.18).toFixed(2));

});

$('#resultados tbody').on( 'click', 'input', function (e) {
	$("#alertaNinguna").hide();
	var	temp12 = $(this).attr("x-idCobro");
	var	temp22 = $(this).attr("x-tipe");
	if($(this).is(':checked')){
		//agregar en le segunda tabla
		seleccionados.push($(this).attr("x-idCobro"));
		seleccionadosTipos.push($(this).attr("x-tipe"));
		$.post("?do=cobros.obtenerCobro", {
			'idCobro' : $(this).attr("x-idCobro"),
			'tipo' : $(this).attr("x-tipe"),
			},
			function(data) {
			  dTableSeleccionados.fnAddData([
				  '<i class="red ace-icon fa fa-remove bigger-130" x-value="' + data.cobroId + '"></i>',
				  data.tipo + "<input class='inputSeleccion' name='test' x-tipe='" + temp22 + "' x-idCobro='" + temp12 + "' type='hidden' id='test" + data.cobroId + "' value='" + data.cobroId + "'></input>",
				  data.nom,
				  data.avi,
				  data.num,
				  data.neta,
				  data.comP + "% - " + data.com,
				  data.comCP + "% - " + data.comC,
			  ]);
			}, "json");
	}else{
		var index = seleccionados.indexOf($(this).attr("x-idCobro"));
		if (index > -1) {
			seleccionados.splice(index, 1);
			seleccionadosTipos.splice(index, 1);
		}
		$("input.inputSeleccion").each(function() {
			if($(this).val() == temp12){
				var target_row = $(this).closest("tr").get(0);
				var aPos = dTableSeleccionados.fnGetPosition(target_row); 
				dTableSeleccionados.fnDeleteRow(aPos);		
			}	
		});
	}
} );
$('#resultadosSeleccionados tbody').on( 'click', 'i', function (e) {
	var temp13 = $(this).attr("x-value");
	$("input.preSelec").each(function() {
		if($(this).attr("x-idCobro") == temp13){
			$(this).prop('checked', false);	
		}
	});	
	var target_row = $(this).closest("tr").get(0);
	var aPos = dTableSeleccionados.fnGetPosition(target_row); 
	dTableSeleccionados.fnDeleteRow(aPos);	
	var index = seleccionados.indexOf(temp13);
	if (index > -1) {
		seleccionados.splice(index, 1);
		seleccionadosTipos.splice(index, 1);
	}
} );
var temp33;
var temp34;
	
$.ajax({
	url: "?do=cobros.obtenerCobros&ids=" + seleccionados.toString() + "&tipos=" + seleccionadosTipos.toString(),
	dataType: 'json',
	success: function(data){
		$.each(data, function() {
			//console.log(this.nom);
			dTableSeleccionados.fnAddData([
				'',
				this.tipo + "<input class='inputSeleccion' name='test' x-tipe='" + this.tipo + "' x-idCobro='" +   this.cobroId + "' type='hidden' id='test" + this.cobroId + "' value='" + this.cobroId + "'></input>",
				this.nom,
				this.avi,
				this.num,
				this.neta,
				this.comP + "% - " + this.com,
				this.comCP + "% - " + this.comC,
			]);
		});
	},
	error: function(e){
		console.log(e.responseText);
	}
});	
        $("#tablaComisiones").hide();
        $("#buscando").show();
        $("#tablaComisiones .table-header").html("No hay comisiones pendientes para este vendedor");
        $.post("?do=liquidaciones.serializarCedidas", {
                'idPersona': $('#vendedor').val(),
                'moneda': $('#moneda').val()
            },
            function(data) {
                dTable.fnClearTable();
                $("#buscando").hide();
                $("#tablaComisiones").show();
                for (var j = 0; j < data.length; j++) {
                    $("#tablaComisiones .table-header").html("Comisiones Pendientes para " + $('#persona_name').val());
					dTable.fnAddData([
						'<label><input class="preSelec" type="checkbox" class="ace" x-tipe="' + data[j].tipo + '" x-idCobro="' + data[j].cobroId + '"/><span class="lbl"></span> </label>',
						data[j].tipo,
						data[j].nom,
						data[j].avi,
						data[j].num,
						data[j].neta,
						data[j].comiP + "% - " + data[j].comi,
						data[j].comiCP + "% - " + data[j].comiC,
					]);
                }
            }, "json");
    

</script>
<div id="test">
</div>
